---
---

<div class="search-container">
  <button
    id="search-button"
    type="button"
    aria-label="Search"
    class="p-2 rounded-lg hover:opacity-80 transition-opacity"
    style="background-color: var(--color-code-bg);"
  >
    <svg
      class="w-5 h-5"
      fill="none"
      stroke="currentColor"
      viewBox="0 0 24 24"
      style="color: var(--color-text);"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
      />
    </svg>
  </button>

  <div
    id="search-modal"
    class="search-modal hidden"
    role="dialog"
    aria-modal="true"
    aria-label="Search"
  >
    <div class="search-backdrop" id="search-backdrop"></div>
    <div class="search-dialog">
      <div class="search-input-wrapper">
        <svg
          class="search-icon"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
          />
        </svg>
        <input
          id="search-input"
          type="text"
          placeholder="Search posts..."
          autocomplete="off"
          class="search-input"
        />
        <button
          id="search-close"
          type="button"
          aria-label="Close search"
          class="search-close"
        >
          <kbd>Esc</kbd>
        </button>
      </div>
      <div id="search-results" class="search-results"></div>
    </div>
  </div>
</div>

<style>
  .search-container {
    position: relative;
  }

  .search-modal {
    position: fixed;
    inset: 0;
    z-index: 50;
    display: flex;
    align-items: flex-start;
    justify-content: center;
    padding-top: 10vh;
  }

  .search-modal.hidden {
    display: none;
  }

  .search-backdrop {
    position: fixed;
    inset: 0;
    background-color: rgba(0, 0, 0, 0.5);
  }

  .search-dialog {
    position: relative;
    width: 100%;
    max-width: 32rem;
    margin: 0 1rem;
    background-color: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: 0.75rem;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    overflow: hidden;
  }

  .search-input-wrapper {
    display: flex;
    align-items: center;
    padding: 0.75rem 1rem;
    border-bottom: 1px solid var(--color-border);
  }

  .search-icon {
    width: 1.25rem;
    height: 1.25rem;
    color: var(--color-text-muted);
    flex-shrink: 0;
  }

  .search-input {
    flex: 1;
    margin-left: 0.75rem;
    background: transparent;
    border: none;
    outline: none;
    font-size: 1rem;
    color: var(--color-text);
  }

  .search-input::placeholder {
    color: var(--color-text-muted);
  }

  .search-close {
    background: transparent;
    border: none;
    cursor: pointer;
    padding: 0;
  }

  .search-close kbd {
    display: inline-block;
    padding: 0.125rem 0.375rem;
    font-size: 0.75rem;
    font-family: inherit;
    color: var(--color-text-muted);
    background-color: var(--color-code-bg);
    border: 1px solid var(--color-border);
    border-radius: 0.25rem;
  }

  .search-results {
    max-height: 60vh;
    overflow-y: auto;
  }

  .search-results:empty {
    display: none;
  }

  /* Pagefind UI overrides */
  :global(.search-results .pagefind-ui__result) {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid var(--color-border);
    cursor: pointer;
  }

  :global(.search-results .pagefind-ui__result:hover) {
    background-color: var(--color-code-bg);
  }

  :global(.search-results .pagefind-ui__result:last-child) {
    border-bottom: none;
  }

  :global(.search-results .pagefind-ui__result-link) {
    font-weight: 600;
    color: var(--color-text);
    text-decoration: none;
    display: block;
    margin-bottom: 0.25rem;
  }

  :global(.search-results .pagefind-ui__result-link:hover) {
    color: var(--color-accent);
  }

  :global(.search-results .pagefind-ui__result-excerpt) {
    font-size: 0.875rem;
    color: var(--color-text-muted);
    line-height: 1.4;
  }

  :global(.search-results .pagefind-ui__result-excerpt mark) {
    background-color: var(--color-accent);
    color: white;
    padding: 0 0.125rem;
    border-radius: 0.125rem;
  }

  :global(.search-results .pagefind-ui__message) {
    padding: 1rem;
    text-align: center;
    color: var(--color-text-muted);
  }

  .search-no-results {
    padding: 1.5rem 1rem;
    text-align: center;
    color: var(--color-text-muted);
  }
</style>

<script is:inline>
  (function() {
    let pagefind = null;

    async function loadPagefind() {
      if (!pagefind) {
        try {
          pagefind = await import('/pagefind/pagefind.js');
          await pagefind.init();
        } catch (e) {
          console.error('Failed to load pagefind:', e);
        }
      }
      return pagefind;
    }

    function initSearch() {
      const searchButton = document.getElementById('search-button');
      const searchModal = document.getElementById('search-modal');
      const searchBackdrop = document.getElementById('search-backdrop');
      const searchInput = document.getElementById('search-input');
      const searchClose = document.getElementById('search-close');
      const searchResults = document.getElementById('search-results');

      function openSearch() {
        searchModal?.classList.remove('hidden');
        searchInput?.focus();
        document.body.style.overflow = 'hidden';
        loadPagefind();
      }

      function closeSearch() {
        searchModal?.classList.add('hidden');
        if (searchInput) searchInput.value = '';
        if (searchResults) searchResults.innerHTML = '';
        document.body.style.overflow = '';
      }

      async function performSearch(query) {
        if (!searchResults) return;

        if (!query.trim()) {
          searchResults.innerHTML = '';
          return;
        }

        const pf = await loadPagefind();
        if (!pf) {
          searchResults.innerHTML = '<div class="search-no-results">Search unavailable</div>';
          return;
        }

        const search = await pf.search(query);

        if (search.results.length === 0) {
          searchResults.innerHTML = '<div class="search-no-results">No results found</div>';
          return;
        }

        const resultsHtml = await Promise.all(
          search.results.slice(0, 10).map(async (result) => {
            const data = await result.data();
            return `
              <a href="${data.url}" class="pagefind-ui__result">
                <div class="pagefind-ui__result-link">${data.meta?.title || 'Untitled'}</div>
                <div class="pagefind-ui__result-excerpt">${data.excerpt}</div>
              </a>
            `;
          })
        );

        searchResults.innerHTML = resultsHtml.join('');

        // Add click handlers to close modal when clicking a result
        searchResults.querySelectorAll('a').forEach(link => {
          link.addEventListener('click', closeSearch);
        });
      }

      let debounceTimer;
      function debounceSearch(query) {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => performSearch(query), 200);
      }

      // Event listeners
      searchButton?.addEventListener('click', openSearch);
      searchBackdrop?.addEventListener('click', closeSearch);
      searchClose?.addEventListener('click', closeSearch);

      searchInput?.addEventListener('input', (e) => {
        debounceSearch(e.target.value);
      });

      // Keyboard shortcuts
      document.addEventListener('keydown', (e) => {
        // Cmd/Ctrl + K to open search
        if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
          e.preventDefault();
          if (searchModal?.classList.contains('hidden')) {
            openSearch();
          } else {
            closeSearch();
          }
        }

        // Escape to close
        if (e.key === 'Escape' && !searchModal?.classList.contains('hidden')) {
          closeSearch();
        }
      });
    }

    initSearch();
    document.addEventListener('astro:after-swap', initSearch);
  })();
</script>
